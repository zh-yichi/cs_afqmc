#INFO: **** input file is /home/sharmagroup/sharmagroup/cs_afqmc/ad_afqmc/prop_unrestricted/test_urestricted.py ****
from pyscf import gto, scf, cc
import numpy as np

a = 2 # bond length in a cluster
d = 10 # distance between each cluster
na = 2  # size of a cluster (monomer)
nc = 1 # set as integer multiple of monomers
s = 0 # spin per monomer
elmt = 'O'
bs = 'ccpvdz'
atoms = ""
for n in range(nc*na):
    shift = ((n - n % na) // na) * (d-a)
    atoms += f"{elmt} {n*a+shift:.5f} 0.00000 0.00000 \n"

mol = gto.M(atom=atoms, basis=bs,spin=s*nc, unit='bohr', verbose=4)
mol.build()

mf = scf.UHF(mol)
mf.kernel()

nfrozen = 0
mycc = cc.CCSD(mf,frozen=nfrozen)
mycc.kernel()

options = {'n_eql': 3,
           'n_prop_steps': 50,
            'n_ene_blocks': 5,
            'n_sr_blocks': 10,
            'n_blocks': 10,
            'n_walkers': 100,
            'seed': 2,
            'walker_type': 'uhf',
            'trial': 'uccsd_pt2_ad', # ccsd_pt,ccsd_pt_ad,ccsd_pt2_ad, uccsd_pt, uccsd_pt_ad, uccsd_pt2_ad
            'dt':0.005,
            'free_projection':False,
            'ad_mode':None,
            'use_gpu': True,
            }

# from jax import config
# config.update("jax_enable_x64", True)
# config.set

from ad_afqmc import config
config.afqmc_config = {"use_gpu": True}
config.setup_jax()

# from ad_afqmc import pyscf_interface, run_afqmc
from ad_afqmc.prop_unrestricted import prop_unrestricted
prop_unrestricted.prep_afqmc(mycc,options,chol_cut=1e-5)
prop_unrestricted.run_afqmc(options,nproc=5)
# pyscf_interface.prep_afqmc(mf,options,chol_cut=1e-5)
# run_afqmc.run_afqmc(options,nproc=5)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='sharmagroup-rn', release='6.14.0-33-generic', version='#33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2', machine='x86_64')  Threads 16
Python 3.11.14 (main, Oct 21 2025, 18:31:21) [GCC 11.2.0]
numpy 2.3.1  scipy 1.16.2  h5py 3.14.0
Date: Thu Oct 30 17:03:03 2025
PySCF version 2.11.0
PySCF path  /home/sharmagroup/sharmagroup/pyscf
GIT HEAD (branch master) 3d1768f5e33b144b606c3d2c81c12ee54d794501

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 16
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = bohr
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 O      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 O      1.058354421840   0.000000000000   0.000000000000 AA    2.000000000000   0.000000000000   0.000000000000 Bohr   0.0

nuclear repulsion = 32
number of shells = 10
number of NR pGTOs = 52
number of NR cGTOs = 28
basis = ccpvdz
ecp = {}
CPU time:         0.25


******** <class 'pyscf.scf.uhf.UHF'> ********
method = UHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tmp/tmp0tfx3w28
max_memory 4000 MB (current use 109 MB)
number electrons alpha = 8  beta = 8
Set gradient conv threshold to 3.16228e-05
init E= -150.481086252206

WARN: alpha nocc = 8  HOMO -0.0878180137815756 >= LUMO -0.0878180137815747


WARN: beta  nocc = 8  HOMO -0.0876156244232075 >= LUMO -0.0876156244232072


WARN: system HOMO -0.0876156244232075 >= system LUMO -0.0876156244232072

cycle= 1 E= -149.482741538989  delta_E= 0.998  |g|= 0.336  |ddm|= 1.51
  alpha nocc = 8  HOMO = -0.440483265547084  LUMO = 0.0483896758074508
  beta  nocc = 8  HOMO = -0.440879095678074  LUMO = 0.0483247703542936
cycle= 2 E= -149.517986708891  delta_E= -0.0352  |g|= 0.0949  |ddm|= 0.27
  alpha nocc = 8  HOMO = -0.38453114825983  LUMO = 0.112167985878109
  beta  nocc = 8  HOMO = -0.384914324390414  LUMO = 0.112051481939448
cycle= 3 E= -149.521050117727  delta_E= -0.00306  |g|= 0.0135  |ddm|= 0.0667
  alpha nocc = 8  HOMO = -0.393407546086807  LUMO = 0.107169176611918
  beta  nocc = 8  HOMO = -0.393690329731692  LUMO = 0.107053085191946
cycle= 4 E= -149.521153188568  delta_E= -0.000103  |g|= 0.00238  |ddm|= 0.0149
  alpha nocc = 8  HOMO = -0.392859970442134  LUMO = 0.108405272469615
  beta  nocc = 8  HOMO = -0.393001561812047  LUMO = 0.108351083765939
cycle= 5 E= -149.521156765619  delta_E= -3.58e-06  |g|= 0.000396  |ddm|= 0.00253
  alpha nocc = 8  HOMO = -0.39297250832126  LUMO = 0.108388233739634
  beta  nocc = 8  HOMO = -0.393019019142884  LUMO = 0.108375101327885
cycle= 6 E= -149.52115701723  delta_E= -2.52e-07  |g|= 0.000242  |ddm|= 0.000801
  alpha nocc = 8  HOMO = -0.392981721742704  LUMO = 0.108388581081196
  beta  nocc = 8  HOMO = -0.39300973786528  LUMO = 0.108381240133917
cycle= 7 E= -149.521157160608  delta_E= -1.43e-07  |g|= 0.000273  |ddm|= 0.000433
  alpha nocc = 8  HOMO = -0.392974728161991  LUMO = 0.1083939009159
  beta  nocc = 8  HOMO = -0.393018180409718  LUMO = 0.108384429266651
cycle= 8 E= -149.521156629623  delta_E= 5.31e-07  |g|= 8.3e-05  |ddm|= 0.00241
  alpha nocc = 8  HOMO = -0.39299164830716  LUMO = 0.108387137815247
  beta  nocc = 8  HOMO = -0.393000237601438  LUMO = 0.108386153470637
cycle= 9 E= -149.521156596591  delta_E= 3.3e-08  |g|= 9.99e-06  |ddm|= 0.000781
  alpha nocc = 8  HOMO = -0.392994656326294  LUMO = 0.108386202319293
  beta  nocc = 8  HOMO = -0.39299631545752  LUMO = 0.108386074080264
cycle= 10 E= -149.521156596649  delta_E= -5.82e-11  |g|= 2.4e-06  |ddm|= 2.87e-05
  alpha nocc = 8  HOMO = -0.392995026978591  LUMO = 0.108386190263762
  beta  nocc = 8  HOMO = -0.392995885154367  LUMO = 0.108386104343867
Extra cycle  E= -149.521156596653  delta_E= -3.84e-12  |g|= 1.13e-06  |ddm|= 2.77e-06
converged SCF energy = -149.521156596653  <S^2> = 4.2010839e-12  2S+1 = 1

******** <class 'pyscf.cc.uccsd.UCCSD'> ********
CC2 = 0
CCSD nocc = (np.int64(8), np.int64(8)), nmo = (28, 28)
frozen orbitals 0
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-06
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 119 MB)
Init t2, MP2 energy = -0.342933524803381
Init E_corr(UCCSD) = -0.34293352480406
cycle = 1  E_corr(UCCSD) = -0.34191645368732  dE = 0.00101707112  norm(t1,t2) = 0.0562042
cycle = 2  E_corr(UCCSD) = -0.350637892229037  dE = -0.00872143854  norm(t1,t2) = 0.0204009
cycle = 3  E_corr(UCCSD) = -0.351968986661285  dE = -0.00133109443  norm(t1,t2) = 0.0115194
cycle = 4  E_corr(UCCSD) = -0.353289688310349  dE = -0.00132070165  norm(t1,t2) = 0.00771567
cycle = 5  E_corr(UCCSD) = -0.35323700134972  dE = 5.26869606e-05  norm(t1,t2) = 0.00578518
cycle = 6  E_corr(UCCSD) = -0.353508658684064  dE = -0.000271657334  norm(t1,t2) = 0.00229457
cycle = 7  E_corr(UCCSD) = -0.35352332005729  dE = -1.46613732e-05  norm(t1,t2) = 0.000239746
cycle = 8  E_corr(UCCSD) = -0.353513657785063  dE = 9.66227223e-06  norm(t1,t2) = 6.03143e-05
cycle = 9  E_corr(UCCSD) = -0.353514214913222  dE = -5.57128159e-07  norm(t1,t2) = 1.58173e-05
cycle = 10  E_corr(UCCSD) = -0.353514414189298  dE = -1.99276076e-07  norm(t1,t2) = 3.6e-06
cycle = 11  E_corr(UCCSD) = -0.353514414388413  dE = -1.99115058e-10  norm(t1,t2) = 9.3269e-07
UCCSD converged
E(UCCSD) = -149.8746710110417  E_corr = -0.353514414388413
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-33-generic
# Version: #33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2
# Machine: x86_64
# Processor: x86_64
#
# Preparing AFQMC calculation
# If you import pyscf cc modules and use MPI for AFQMC in the same script, finalize MPI before calling the AFQMC driver.
# Calculating Cholesky integrals
# Finished calculating Cholesky integrals
#
# Size of the correlation space:
# Number of electrons: (8, 8)
# Number of basis functions: 28
# Number of Cholesky vectors: 174
#
# running AFQMC on GPU
# AFQMC script: /home/sharmagroup/sharmagroup/cs_afqmc/ad_afqmc/prop_unrestricted/run_afqmc_ccsd_pt2.py
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-33-generic
# Version: #33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2
# Machine: x86_64
# Processor: x86_64
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-33-generic
# Version: #33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2
# Machine: x86_64
# Processor: x86_64
# Number of MPI ranks: 1
#
# norb: 28
# nelec: (8, 8)
#
# n_eql: 3
# n_prop_steps: 50
# n_ene_blocks: 5
# n_sr_blocks: 10
# n_blocks: 10
# n_walkers: 100
# seed: 2
# walker_type: uhf
# trial: uccsd_pt2_ad
# dt: 0.005
# free_projection: False
# use_gpu: True
# n_exp_terms: 6
# orbital_rotation: True
# do_sr: True
# symmetry: False
# save_walkers: False
# ene0: 0.0
# n_batch: 1
# LNO: False
# orbE: 0
# maxError: 0.001
#
# 

# Propagating with 100 walkers
# Equilibration sweeps:
#   Iter  <exp(t1)>  <t2>  <e0>  <e1>  energy  Walltime
      0  0.999042  0.000000  -181.347287   -0.353151   -149.874665  4.67
      1  1.000683  0.109368  -182.001266   -19.899704   -149.885330  50.37
      2  1.000966  0.147039  -182.071915   -26.735319   -149.885723  95.65
      3  1.001061  0.176905  -182.090698   -32.174328   -149.893570  136.91
#
# Sampling sweeps:
#  Iter 	 energy 	 error 	 	 Walltime
     1 	 	 -149.890350 	 0.002899 	  219.55
     2 	 	 -149.891205 	 0.001762 	  260.87
     3 	 	 -149.890610 	 0.001424 	  302.19
     4 	 	 -149.890602 	 0.001118 	  343.52
     5 	 	 -149.891376 	 0.001138 	  384.89
     6 	 	 -149.891182 	 0.001014 	  426.26
     7 	 	 -149.892048 	 0.001248 	  467.64
     8 	 	 -149.891899 	 0.001129 	  509.02
     9 	 	 -149.892151 	 0.001031 	  550.54
# Number of outliers in post: 0 
Final Results1:
# h0 = 32.00000000
# <exp(t1)> = 1.000908 +/- 0.000046
# <t2> = 0.189487 +/- 0.002842
# <e0> = -182.063904 +/- 0.008766
# <e1> = -34.460957 +/- 0.516711
# AFQMC/UCCSD_PT2 energy (covariance): -149.892185 +/- 0.001031
# remove outliers:  0
# AFQMC/UCCSD_PT2 energy (direct obs): -149.891968 +/- 0.001036
# total run time: 550.54
# mem: 440 MB
