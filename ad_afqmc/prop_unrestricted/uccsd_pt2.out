#INFO: **** input file is /home/yichi/research/software/cs_afqmc/ad_afqmc/prop_unrestricted/test_urestricted.py ****
from pyscf import gto, scf, cc
import numpy as np

a = 2 # bond length in a cluster
d = 10 # distance between each cluster
na = 3  # size of a cluster (monomer)
nc = 1 # set as integer multiple of monomers
s = 1 # spin per monomer
elmt = 'H'
bs = 'sto6g'
atoms = ""
for n in range(nc*na):
    shift = ((n - n % na) // na) * (d-a)
    atoms += f"{elmt} {n*a+shift:.5f} 0.00000 0.00000 \n"

mol = gto.M(atom=atoms, basis=bs,spin=s*nc, unit='bohr', verbose=4)
mol.build()

mf = scf.UHF(mol)
mf.kernel()

nfrozen = 0
mycc = cc.CCSD(mf,frozen=nfrozen)
mycc.kernel()

options = {'n_eql': 3,
           'n_prop_steps': 50,
            'n_ene_blocks': 5,
            'n_sr_blocks': 5,
            'n_blocks': 10,
            'n_walkers': 1,
            'seed': 2,
            'walker_type': 'uhf',
            'trial': 'uccsd_pt2',
            'dt':0.005,
            'free_projection':False,
            'ad_mode':None,
            'use_gpu': False,
            }

# from jax import config
# config.update("jax_enable_x64", True)
# config.set

# from ad_afqmc import config
# config.afqmc_config = {"use_gpu": True}
# config.setup_jax()

# from ad_afqmc import pyscf_interface, run_afqmc
from ad_afqmc.prop_unrestricted import prop_unrestricted
prop_unrestricted.prep_afqmc(mycc,options,chol_cut=1e-5)
prop_unrestricted.run_afqmc(options,nproc=1,dbg=True)
# pyscf_interface.prep_afqmc(mf,options,chol_cut=1e-5)
# run_afqmc.run_afqmc(options,nproc=5)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='yichi-thinkpad', release='4.4.0-26100-Microsoft', version='#5074-Microsoft Fri Jan 01 08:00:00 PST 2016', machine='x86_64')  Threads 12
Python 3.10.16 | packaged by conda-forge | (main, Dec  5 2024, 14:16:10) [GCC 13.3.0]
numpy 1.24.3  scipy 1.14.1  h5py 3.12.1
Date: Sun Nov  2 21:11:50 2025
PySCF version 2.8.0
PySCF path  /home/yichi/research/software/lno_pyscf
GIT HEAD (branch master) ef75f4190e4de208685670651dc6c467f72b6794

[ENV] PYSCF_EXT_PATH /home/yichi/research/software/pyscf
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 3
[INPUT] num. electrons = 3
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 1
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = bohr
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 H      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 H      1.058354421840   0.000000000000   0.000000000000 AA    2.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  3 H      2.116708843680   0.000000000000   0.000000000000 AA    4.000000000000   0.000000000000   0.000000000000 Bohr   0.0

nuclear repulsion = 1.25
number of shells = 3
number of NR pGTOs = 18
number of NR cGTOs = 3
basis = sto6g
ecp = {}
CPU time:         2.11


******** <class 'pyscf.scf.uhf.UHF'> ********
method = UHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tmp/tmpj4mz90g5
max_memory 4000 MB (current use 82 MB)
number electrons alpha = 2  beta = 1
Set gradient conv threshold to 3.16228e-05
init E= -1.09833379602073
  alpha nocc = 2  HOMO = -0.0642951585462982  LUMO = 0.556124250248253
  beta  nocc = 1  HOMO = -0.510193886664917  LUMO = -0.0642951585462982

WARN: system HOMO -0.0642951585462982 >= system LUMO -0.0642951585462982

cycle= 1 E= -1.52291578799343  delta_E= -0.425  |g|= 0.101  |ddm|= 0.981
  alpha nocc = 2  HOMO = -0.342804209141319  LUMO = 0.552999233691284
  beta  nocc = 1  HOMO = -0.472344060842248  LUMO = 0.18425353450897
cycle= 2 E= -1.53678216302207  delta_E= -0.0139  |g|= 0.0598  |ddm|= 0.149
  alpha nocc = 2  HOMO = -0.382461570010245  LUMO = 0.598301909926251
  beta  nocc = 1  HOMO = -0.513098488108381  LUMO = 0.227828443795091
cycle= 3 E= -1.54391161439014  delta_E= -0.00713  |g|= 0.00136  |ddm|= 0.212
  alpha nocc = 2  HOMO = -0.381183716651503  LUMO = 0.591044921973335
  beta  nocc = 1  HOMO = -0.50633065910123  LUMO = 0.226384718324634
cycle= 4 E= -1.54391383286594  delta_E= -2.22e-06  |g|= 0.000252  |ddm|= 0.00408
  alpha nocc = 2  HOMO = -0.381365650825405  LUMO = 0.591474906067928
  beta  nocc = 1  HOMO = -0.506936699468207  LUMO = 0.226482731905911
cycle= 5 E= -1.54391393088129  delta_E= -9.8e-08  |g|= 0.000109  |ddm|= 0.000493
  alpha nocc = 2  HOMO = -0.381416266772273  LUMO = 0.591594530395744
  beta  nocc = 1  HOMO = -0.507106317545106  LUMO = 0.226509887562583
cycle= 6 E= -1.54391394423282  delta_E= -1.34e-08  |g|= 6.91e-05  |ddm|= 0.000136
  alpha nocc = 2  HOMO = -0.381439895092969  LUMO = 0.591650371572534
  beta  nocc = 1  HOMO = -0.507185701733907  LUMO = 0.226522541467055
cycle= 7 E= -1.54391394841369  delta_E= -4.18e-09  |g|= 5.05e-05  |ddm|= 6.35e-05
  alpha nocc = 2  HOMO = -0.38145356089859  LUMO = 0.591682667482244
  beta  nocc = 1  HOMO = -0.507231689427366  LUMO = 0.226529851691103
cycle= 8 E= -1.54391395023835  delta_E= -1.82e-09  |g|= 3.98e-05  |ddm|= 3.67e-05
  alpha nocc = 2  HOMO = -0.381462464571949  LUMO = 0.591703708817234
  beta  nocc = 1  HOMO = -0.507261687249942  LUMO = 0.226534610536127
cycle= 9 E= -1.54391395119386  delta_E= -9.56e-10  |g|= 3.29e-05  |ddm|= 2.39e-05
  alpha nocc = 2  HOMO = -0.381507324481792  LUMO = 0.591809746812438
  beta  nocc = 1  HOMO = -0.507411776822367  LUMO = 0.226558706256151
cycle= 10 E= -1.54391395322183  delta_E= -2.03e-09  |g|= 2.4e-06  |ddm|= 0.000121
  alpha nocc = 2  HOMO = -0.381504670927539  LUMO = 0.591803440309698
  beta  nocc = 1  HOMO = -0.507404634921084  LUMO = 0.226557084814668
cycle= 11 E= -1.54391395323278  delta_E= -1.09e-11  |g|= 3.81e-09  |ddm|= 8.28e-06
  alpha nocc = 2  HOMO = -0.381504668219612  LUMO = 0.591803431923704
  beta  nocc = 1  HOMO = -0.50740462657452  LUMO = 0.226557083760533
Extra cycle  E= -1.54391395323278  delta_E= 4.44e-16  |g|= 2.14e-09  |ddm|= 5.76e-09
converged SCF energy = -1.54391395323278  <S^2> = 0.83069313  2S+1 = 2.0791278

******** <class 'pyscf.cc.uccsd.UCCSD'> ********
CC2 = 0
CCSD nocc = (2, 1), nmo = (3, 3)
frozen orbitals 0
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-06
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 87 MB)
Init t2, MP2 energy = -0.0123732281138468
Init E_corr(UCCSD) = -0.0123732281138468
cycle = 1  E_corr(UCCSD) = -0.0189459072155576  dE = -0.0065726791  norm(t1,t2) = 0.0459125
cycle = 2  E_corr(UCCSD) = -0.0227639799001316  dE = -0.00381807268  norm(t1,t2) = 0.0302784
cycle = 3  E_corr(UCCSD) = -0.0295398993102219  dE = -0.00677591941  norm(t1,t2) = 0.0203335
cycle = 4  E_corr(UCCSD) = -0.0293023527777728  dE = 0.000237546532  norm(t1,t2) = 0.00242585
cycle = 5  E_corr(UCCSD) = -0.0293957098528535  dE = -9.33570751e-05  norm(t1,t2) = 0.000245802
cycle = 6  E_corr(UCCSD) = -0.0293931137926039  dE = 2.59606025e-06  norm(t1,t2) = 9.53029e-06
cycle = 7  E_corr(UCCSD) = -0.0293928144574576  dE = 2.99335146e-07  norm(t1,t2) = 1.80731e-06
cycle = 8  E_corr(UCCSD) = -0.029392514795712  dE = 2.99661746e-07  norm(t1,t2) = 9.74921e-07
cycle = 9  E_corr(UCCSD) = -0.0293924678560005  dE = 4.69397116e-08  norm(t1,t2) = 1.4313e-07
UCCSD converged
E(UCCSD) = -1.573306421088776  E_corr = -0.02939246785600046
#
# Preparing AFQMC calculation
# If you import pyscf cc modules and use MPI for AFQMC in the same script, finalize MPI before calling the AFQMC driver.
# Calculating Cholesky integrals
# Finished calculating Cholesky integrals
#
# Size of the correlation space:
# Number of electrons: (2, 1)
# Number of basis functions: 3
# Number of Cholesky vectors: 6
#
# running AFQMC on CPU
# AFQMC script: /home/yichi/research/software/cs_afqmc/ad_afqmc/prop_unrestricted/run_afqmc_ccsd_pt2_dbg.py
# Hostname: yichi-thinkpad
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Hostname: yichi-thinkpad
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Number of MPI ranks: 1
#
# norb: 3
# nelec: (2, 1)
#
# n_eql: 3
# n_prop_steps: 50
# n_ene_blocks: 5
# n_sr_blocks: 5
# n_blocks: 10
# n_walkers: 1
# seed: 2
# walker_type: uhf
# trial: uccsd_pt2
# dt: 0.005
# free_projection: False
# use_gpu: False
# n_exp_terms: 6
# orbital_rotation: True
# do_sr: True
# symmetry: False
# save_walkers: False
# ene0: 0.0
# n_batch: 1
# LNO: False
# orbE: 0
# maxError: 0.001
#
# 

# Propagating with 1 walkers
# Equilibration sweeps:
#   Iter 	 <exp(t1)> 	 <t2> 	 	    <e0> 	 <e1> 	 	 energy 	    <ehf> 	 Walltime
      0 	 -0.997754 	 -0.000000 	  2.787921 	 0.029043 	 -1.573306 	  -1.543914 	 7.85
      1 	 -1.001813 	 -0.022477 	  2.814862 	 0.077022 	 -1.573610 	  -1.560363 	 15.20
      2 	 -1.010273 	 -0.009436 	  2.825896 	 0.053055 	 -1.573551 	  -1.554475 	 20.55
      3 	 -1.006363 	 -0.020764 	  2.823591 	 0.076302 	 -1.573669 	  -1.559474 	 20.63
#
# Sampling sweeps:
#  Iter 	 pt_energy 	 error 	 	 hf_energy 	 Walltime
     1 	 	 -1.573618 	 0.000113 	  -1.563776 	 20.83
     2 	 	 -1.573285 	 0.000564 	  -1.572782 	 20.91
     3 	 	 -1.573407 	 0.000344 	  -1.570384 	 20.99
     4 	 	 -1.573411 	 0.000265 	  -1.570284 	 21.07
     5 	 	 -1.573513 	 0.000187 	  -1.567802 	 21.15
     6 	 	 -1.573452 	 0.000199 	  -1.569399 	 21.22
     7 	 	 -1.573452 	 0.000170 	  -1.569555 	 21.30
     8 	 	 -1.573469 	 0.000144 	  -1.569107 	 21.38
     9 	 	 -1.573473 	 0.000125 	  -1.569232 	 21.46
# Number of outliers in post: 0 
Final Results1:
# h0 = 1.25000000
# <exp(t1)> = -1.003527 +/- 0.000614
# <t2> = -0.032656 +/- 0.001503
# <e0> = 2.828146 +/- 0.000725
# <e1> = 0.097318 +/- 0.002862
# <ehf> = -1.569232 +/- 0.000855
# AFQMC/UCCSD_PT2 energy (covariance): -1.573473 +/- 0.000125
# remove outliers:  1
# AFQMC/UCCSD_PT2 energy (direct obs): -1.573457 +/- 0.000075
# total run time: 21.46
