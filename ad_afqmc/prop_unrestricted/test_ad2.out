#INFO: **** input file is /home/sharmagroup/sharmagroup/cs_afqmc/ad_afqmc/prop_unrestricted/test.py ****
from pyscf import gto, scf, cc
import numpy as np

a = 2 # bond length in a cluster
d = 10 # distance between each cluster
na = 2  # size of a cluster (monomer)
nc = 1 # set as integer multiple of monomers
elmt = 'O'
atoms = ""
for n in range(nc*na):
    shift = ((n - n % na) // na) * (d-a)
    atoms += f"{elmt} {n*a+shift:.5f} 0.00000 0.00000 \n"

mol = gto.M(atom=atoms, basis="ccpvdz",spin=0*nc, unit='bohr', verbose=4)
mol.build()

mf = scf.UHF(mol)
e = mf.kernel()

nfrozen = 2

mycc = cc.CCSD(mf,frozen=nfrozen)
mycc.kernel()

options = {'n_eql': 3,
           'n_prop_steps': 50,
            'n_ene_blocks': 5,
            'n_sr_blocks': 5,
            'n_blocks': 10,
            'n_walkers': 200,
            'seed': 2,
            'walker_type': 'uhf',
            'trial': 'uccsd_pt2_true_ad', # ccsd_pt,ccsd_pt_ad,ccsd_pt2_ad, uccsd_pt, uccsd_pt_ad, uccsd_pt2_ad
            'dt':0.005,
            'free_projection':False,
            'ad_mode':None,
            'use_gpu': True,
            }

from jax import config
config.update("jax_enable_x64", True)

from ad_afqmc import config
config.afqmc_config["use_gpu"] = True
config.setup_jax()
# config.afqmc_config = {"use_gpu": True}

from ad_afqmc import pyscf_interface, run_afqmc
from ad_afqmc.prop_unrestricted import prop_unrestricted
prop_unrestricted.prep_afqmc(mycc,options,chol_cut=1e-5)
prop_unrestricted.run_afqmc(options,nproc=5)
# pyscf_interface.prep_afqmc(mycc,options,chol_cut=1e-6)
# run_afqmc.run_afqmc(options)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='sharmagroup-rn', release='6.14.0-34-generic', version='#34~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Tue Sep 23 15:35:20 UTC 2', machine='x86_64')  Threads 16
Python 3.11.14 (main, Oct 21 2025, 18:31:21) [GCC 11.2.0]
numpy 2.3.1  scipy 1.16.2  h5py 3.14.0
Date: Wed Nov  5 17:30:51 2025
PySCF version 2.11.0
PySCF path  /home/sharmagroup/sharmagroup/pyscf
GIT HEAD (branch master) 3d1768f5e33b144b606c3d2c81c12ee54d794501

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 16
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = bohr
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 O      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 O      1.058354421840   0.000000000000   0.000000000000 AA    2.000000000000   0.000000000000   0.000000000000 Bohr   0.0

nuclear repulsion = 32
number of shells = 10
number of NR pGTOs = 52
number of NR cGTOs = 28
basis = ccpvdz
ecp = {}
CPU time:         0.26


******** <class 'pyscf.scf.uhf.UHF'> ********
method = UHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tmp/tmpcen3r67l
max_memory 4000 MB (current use 109 MB)
number electrons alpha = 8  beta = 8
Set gradient conv threshold to 3.16228e-05
init E= -150.481086252206

WARN: alpha nocc = 8  HOMO -0.0878180137815756 >= LUMO -0.0878180137815729


WARN: beta  nocc = 8  HOMO -0.0876156244232089 >= LUMO -0.0876156244232066


WARN: system HOMO -0.0876156244232089 >= system LUMO -0.0876156244232066

cycle= 1 E= -149.482962572547  delta_E= 0.998  |g|= 0.337  |ddm|= 1.51
  alpha nocc = 8  HOMO = -0.440730491905231  LUMO = 0.0486277487626384
  beta  nocc = 8  HOMO = -0.441126310173686  LUMO = 0.0485628590868627
cycle= 2 E= -149.51835358897  delta_E= -0.0354  |g|= 0.0952  |ddm|= 0.27
  alpha nocc = 8  HOMO = -0.384874027946908  LUMO = 0.112524599788301
  beta  nocc = 8  HOMO = -0.385257127115392  LUMO = 0.112408091271178
cycle= 3 E= -149.521552597079  delta_E= -0.0032  |g|= 0.0159  |ddm|= 0.068
  alpha nocc = 8  HOMO = -0.393940607315207  LUMO = 0.107734697616503
  beta  nocc = 8  HOMO = -0.394223403072122  LUMO = 0.107618536256159
cycle= 4 E= -149.521909814841  delta_E= -0.000357  |g|= 0.0102  |ddm|= 0.0263
  alpha nocc = 8  HOMO = -0.393689061311611  LUMO = 0.109008177536976
  beta  nocc = 8  HOMO = -0.39385224283955  LUMO = 0.108944517114134
cycle= 5 E= -149.522219842677  delta_E= -0.00031  |g|= 0.0117  |ddm|= 0.022
  alpha nocc = 8  HOMO = -0.393987638169447  LUMO = 0.10974965272966
  beta  nocc = 8  HOMO = -0.394413110214244  LUMO = 0.10957098475399
cycle= 6 E= -149.521209357897  delta_E= 0.00101  |g|= 0.00298  |ddm|= 0.108
  alpha nocc = 8  HOMO = -0.393058539636349  LUMO = 0.108564579056271
  beta  nocc = 8  HOMO = -0.393238777655288  LUMO = 0.108507376962494
cycle= 7 E= -149.521156543403  delta_E= 5.28e-05  |g|= 0.000294  |ddm|= 0.031
  alpha nocc = 8  HOMO = -0.392907715877826  LUMO = 0.108342489555922
  beta  nocc = 8  HOMO = -0.39296420895849  LUMO = 0.108329176407738
cycle= 8 E= -149.52115659245  delta_E= -4.9e-08  |g|= 7.19e-05  |ddm|= 0.000613
  alpha nocc = 8  HOMO = -0.393006856470448  LUMO = 0.108401942497308
  beta  nocc = 8  HOMO = -0.393020488975193  LUMO = 0.108399454241164
cycle= 9 E= -149.521156596474  delta_E= -4.02e-09  |g|= 1.57e-05  |ddm|= 0.000128
  alpha nocc = 8  HOMO = -0.392993374356214  LUMO = 0.108385363380993
  beta  nocc = 8  HOMO = -0.392995723519071  LUMO = 0.108385254018912
cycle= 10 E= -149.521156596645  delta_E= -1.71e-10  |g|= 3.17e-06  |ddm|= 3.54e-05
  alpha nocc = 8  HOMO = -0.39299484455867  LUMO = 0.108386109350057
  beta  nocc = 8  HOMO = -0.392996042016901  LUMO = 0.108386015170312
Extra cycle  E= -149.521156596653  delta_E= -7.82e-12  |g|= 1.54e-06  |ddm|= 3.78e-06
converged SCF energy = -149.521156596653  <S^2> = 1.9117152e-11  2S+1 = 1

******** <class 'pyscf.cc.uccsd.UCCSD'> ********
CC2 = 0
CCSD nocc = (np.int64(6), np.int64(6)), nmo = (26, 26)
frozen orbitals 2
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-06
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 120 MB)
Init t2, MP2 energy = -0.338581200087341
Init E_corr(UCCSD) = -0.338581200088711
cycle = 1  E_corr(UCCSD) = -0.338063444003859  dE = 0.000517756085  norm(t1,t2) = 0.0562395
cycle = 2  E_corr(UCCSD) = -0.346755532042621  dE = -0.00869208804  norm(t1,t2) = 0.0204181
cycle = 3  E_corr(UCCSD) = -0.348131693449302  dE = -0.00137616141  norm(t1,t2) = 0.0115575
cycle = 4  E_corr(UCCSD) = -0.34944073166257  dE = -0.00130903821  norm(t1,t2) = 0.0077432
cycle = 5  E_corr(UCCSD) = -0.349385230557887  dE = 5.55011047e-05  norm(t1,t2) = 0.00582433
cycle = 6  E_corr(UCCSD) = -0.349668133586549  dE = -0.000282903029  norm(t1,t2) = 0.00232347
cycle = 7  E_corr(UCCSD) = -0.349679321736994  dE = -1.11881504e-05  norm(t1,t2) = 0.000238994
cycle = 8  E_corr(UCCSD) = -0.349669998146295  dE = 9.3235907e-06  norm(t1,t2) = 6.02156e-05
cycle = 9  E_corr(UCCSD) = -0.349670586523204  dE = -5.8837691e-07  norm(t1,t2) = 1.56007e-05
cycle = 10  E_corr(UCCSD) = -0.349670797056937  dE = -2.10533732e-07  norm(t1,t2) = 3.85349e-06
cycle = 11  E_corr(UCCSD) = -0.349670791288583  dE = 5.76835346e-09  norm(t1,t2) = 1.7358e-06
cycle = 12  E_corr(UCCSD) = -0.349670779706375  dE = 1.15822084e-08  norm(t1,t2) = 1.74186e-06
cycle = 13  E_corr(UCCSD) = -0.349670783030072  dE = -3.32369771e-09  norm(t1,t2) = 1.76456e-06
cycle = 14  E_corr(UCCSD) = -0.349670781121585  dE = 1.90848731e-09  norm(t1,t2) = 1.75813e-06
cycle = 15  E_corr(UCCSD) = -0.34967078130153  dE = -1.79944393e-10  norm(t1,t2) = 1.77002e-06
cycle = 16  E_corr(UCCSD) = -0.349670768318619  dE = 1.29829108e-08  norm(t1,t2) = 1.76694e-06
cycle = 17  E_corr(UCCSD) = -0.349670748790491  dE = 1.95281278e-08  norm(t1,t2) = 1.79496e-06
cycle = 18  E_corr(UCCSD) = -0.349670775854374  dE = -2.70638827e-08  norm(t1,t2) = 1.91027e-06
cycle = 19  E_corr(UCCSD) = -0.349670774412361  dE = 1.44201273e-09  norm(t1,t2) = 1.05547e-06
cycle = 20  E_corr(UCCSD) = -0.349670723031041  dE = 5.13813204e-08  norm(t1,t2) = 4.09636e-07
UCCSD converged
E(UCCSD) = -149.8708273196843  E_corr = -0.3496707230310406
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-34-generic
# Version: #34~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Tue Sep 23 15:35:20 UTC 2
# Machine: x86_64
# Processor: x86_64
#
# Preparing AFQMC calculation
# If you import pyscf cc modules and use MPI for AFQMC in the same script, finalize MPI before calling the AFQMC driver.
# Calculating Cholesky integrals
# Finished calculating Cholesky integrals
#
# Size of the correlation space:
# Number of electrons: (6, 6)
# Number of basis functions: 26
# Number of Cholesky vectors: 174
#
# running AFQMC on GPU
# AFQMC script: /home/sharmagroup/sharmagroup/cs_afqmc/ad_afqmc/prop_unrestricted/run_afqmc_ccsd_pt2.py
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-34-generic
# Version: #34~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Tue Sep 23 15:35:20 UTC 2
# Machine: x86_64
# Processor: x86_64
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-34-generic
# Version: #34~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Tue Sep 23 15:35:20 UTC 2
# Machine: x86_64
# Processor: x86_64
# Number of MPI ranks: 1
#
# norb: 26
# nelec: (6, 6)
#
# n_eql: 3
# n_prop_steps: 50
# n_ene_blocks: 5
# n_sr_blocks: 5
# n_blocks: 10
# n_walkers: 200
# seed: 2
# walker_type: uhf
# trial: uccsd_pt2_true_ad
# dt: 0.005
# free_projection: False
# use_gpu: True
# n_exp_terms: 6
# orbital_rotation: True
# do_sr: True
# symmetry: False
# save_walkers: False
# ene0: 0.0
# n_batch: 1
# LNO: False
# orbE: 0
# maxError: 0.001
#
# 

# Propagating with 200 walkers
# Equilibration sweeps:
#   Iter  <exp(t1)>  <t2>  <e0>  <e1>  energy  Walltime
      0  0.999042  0.000000  -49.262430   -0.349312   -149.870832  4.95
      1  1.000607  0.102311  -49.694066   -5.086212   -149.880473  25.36
      2  1.001082  0.138290  -49.739582   -6.857303   -149.883600  45.25
      3  1.000992  0.156086  -49.734904   -7.744099   -149.886041  61.12
#
# Sampling sweeps:
#  Iter 	 energy 	 error 	 	 Walltime
     1 	 	 -149.889795 	 0.002377 	  92.86
     2 	 	 -149.888372 	 0.001983 	  108.72
     3 	 	 -149.888402 	 0.001415 	  124.58
     4 	 	 -149.889454 	 0.001520 	  140.47
     5 	 	 -149.888222 	 0.001750 	  156.39
     6 	 	 -149.887905 	 0.001513 	  172.31
     7 	 	 -149.887959 	 0.001312 	  188.24
     8 	 	 -149.887809 	 0.001167 	  204.16
     9 	 	 -149.887579 	 0.001069 	  220.10
# Number of outliers in post: 0 
Final Results1:
# h0 = -100.21151792
# <exp(t1)> = 1.000968 +/- 0.000038
# <t2> = 0.174956 +/- 0.001330
# <e0> = -49.726453 +/- 0.002395
# <e1> = -8.689222 +/- 0.065790
# AFQMC/UCCSD_PT2 energy (covariance): -149.887579 +/- 0.001069
# remove outliers:  0
# AFQMC/UCCSD_PT2 energy (direct obs): -149.887513 +/- 0.001066
# total run time: 220.10
