#INFO: **** input file is /home/sharmagroup/sharmagroup/cs_afqmc/ad_afqmc/prop_unrestricted/test_urestricted.py ****
from pyscf import gto, scf, cc
import numpy as np

a = 2 # bond length in a cluster
d = 10 # distance between each cluster
na = 2  # size of a cluster (monomer)
nc = 1 # set as integer multiple of monomers
s = 0 # spin per monomer
elmt = 'O'
bs = 'ccpvdz'
atoms = ""
for n in range(nc*na):
    shift = ((n - n % na) // na) * (d-a)
    atoms += f"{elmt} {n*a+shift:.5f} 0.00000 0.00000 \n"

mol = gto.M(atom=atoms, basis=bs,spin=s*nc, unit='bohr', verbose=4)
mol.build()

mf = scf.UHF(mol)
mf.kernel()

nfrozen = 0
mycc = cc.CCSD(mf,frozen=nfrozen)
mycc.kernel()

options = {'n_eql': 3,
           'n_prop_steps': 50,
            'n_ene_blocks': 5,
            'n_sr_blocks': 10,
            'n_blocks': 10,
            'n_walkers': 100,
            'seed': 2,
            'walker_type': 'uhf',
            'trial': 'uccsd_pt2_true_ad', # ccsd_pt,ccsd_pt_ad,ccsd_pt2_ad, uccsd_pt, uccsd_pt_ad, uccsd_pt2_ad
            'dt':0.005,
            'free_projection':False,
            'ad_mode':None,
            'use_gpu': True,
            }

# from jax import config
# config.update("jax_enable_x64", True)
# config.set

from ad_afqmc import config
config.afqmc_config = {"use_gpu": True}
config.setup_jax()

# from ad_afqmc import pyscf_interface, run_afqmc
from ad_afqmc.prop_unrestricted import prop_unrestricted
prop_unrestricted.prep_afqmc(mycc,options,chol_cut=1e-5)
prop_unrestricted.run_afqmc(options,nproc=5)
# pyscf_interface.prep_afqmc(mf,options,chol_cut=1e-5)
# run_afqmc.run_afqmc(options,nproc=5)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='sharmagroup-rn', release='6.14.0-33-generic', version='#33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2', machine='x86_64')  Threads 16
Python 3.11.14 (main, Oct 21 2025, 18:31:21) [GCC 11.2.0]
numpy 2.3.1  scipy 1.16.2  h5py 3.14.0
Date: Thu Oct 30 16:34:51 2025
PySCF version 2.11.0
PySCF path  /home/sharmagroup/sharmagroup/pyscf
GIT HEAD (branch master) 3d1768f5e33b144b606c3d2c81c12ee54d794501

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 16
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = bohr
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 O      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 O      1.058354421840   0.000000000000   0.000000000000 AA    2.000000000000   0.000000000000   0.000000000000 Bohr   0.0

nuclear repulsion = 32
number of shells = 10
number of NR pGTOs = 52
number of NR cGTOs = 28
basis = ccpvdz
ecp = {}
CPU time:         0.25


******** <class 'pyscf.scf.uhf.UHF'> ********
method = UHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tmp/tmp_icf9u_v
max_memory 4000 MB (current use 109 MB)
number electrons alpha = 8  beta = 8
Set gradient conv threshold to 3.16228e-05
init E= -150.481086252206

WARN: alpha nocc = 8  HOMO -0.087818013781576 >= LUMO -0.0878180137815747


WARN: beta  nocc = 8  HOMO -0.0876156244232082 >= LUMO -0.0876156244232063


WARN: system HOMO -0.0876156244232082 >= system LUMO -0.0876156244232063

cycle= 1 E= -149.499762460285  delta_E= 0.981  |g|= 0.349  |ddm|= 1.51
  alpha nocc = 8  HOMO = -0.458860214254003  LUMO = 0.0660606148294763
  beta  nocc = 8  HOMO = -0.459255551681428  LUMO = 0.0659973499539463
cycle= 2 E= -149.542687928089  delta_E= -0.0429  |g|= 0.108  |ddm|= 0.291
  alpha nocc = 8  HOMO = -0.406950028005613  LUMO = 0.136172326914426
  beta  nocc = 8  HOMO = -0.407328451354561  LUMO = 0.136055815177388
cycle= 3 E= -149.550328072301  delta_E= -0.00764  |g|= 0.0472  |ddm|= 0.101
  alpha nocc = 8  HOMO = -0.424689000502804  LUMO = 0.137852802816336
  beta  nocc = 8  HOMO = -0.424951489325472  LUMO = 0.137733726633905
cycle= 4 E= -149.556631197735  delta_E= -0.0063  |g|= 0.041  |ddm|= 0.113
  alpha nocc = 8  HOMO = -0.432948724950473  LUMO = 0.1497930287421
  beta  nocc = 8  HOMO = -0.432985254794615  LUMO = 0.149776174206596
cycle= 5 E= -149.564124871354  delta_E= -0.00749  |g|= 0.0352  |ddm|= 0.147
  alpha nocc = 8  HOMO = -0.511966754744599  LUMO = 0.223017862082141
  beta  nocc = 8  HOMO = -0.511518052431192  LUMO = 0.223227847159697
cycle= 6 E= -149.575808248893  delta_E= -0.0117  |g|= 0.0384  |ddm|= 0.53
  alpha nocc = 8  HOMO = -0.46642702975079  LUMO = 0.181065680623048
  beta  nocc = 8  HOMO = -0.46620447638285  LUMO = 0.181182351213982
cycle= 7 E= -149.576437851192  delta_E= -0.00063  |g|= 0.0137  |ddm|= 0.103
  alpha nocc = 8  HOMO = -0.446801854363648  LUMO = 0.162965480370972
  beta  nocc = 8  HOMO = -0.44685763486984  LUMO = 0.162936872268579
cycle= 8 E= -149.576699560377  delta_E= -0.000262  |g|= 0.00124  |ddm|= 0.0459
  alpha nocc = 8  HOMO = -0.448629143251187  LUMO = 0.16460583002959
  beta  nocc = 8  HOMO = -0.448655338598926  LUMO = 0.16459072531493
cycle= 9 E= -149.57670768296  delta_E= -8.12e-06  |g|= 0.000719  |ddm|= 0.0163
  alpha nocc = 8  HOMO = -0.447372288671332  LUMO = 0.163409174191703
  beta  nocc = 8  HOMO = -0.447382719761544  LUMO = 0.16340441050346
cycle= 10 E= -149.576708682376  delta_E= -9.99e-07  |g|= 9.63e-05  |ddm|= 0.00396
  alpha nocc = 8  HOMO = -0.44756933071335  LUMO = 0.163591895927033
  beta  nocc = 8  HOMO = -0.44757175173405  LUMO = 0.163591007408302
cycle= 11 E= -149.576708688622  delta_E= -6.25e-09  |g|= 2.05e-05  |ddm|= 0.000237
  alpha nocc = 8  HOMO = -0.447544155528223  LUMO = 0.163566660799833
  beta  nocc = 8  HOMO = -0.44754467956042  LUMO = 0.163566505459187
cycle= 12 E= -149.576708688856  delta_E= -2.34e-10  |g|= 4.74e-06  |ddm|= 2.12e-05
  alpha nocc = 8  HOMO = -0.447536629057735  LUMO = 0.163559769662766
  beta  nocc = 8  HOMO = -0.447536878630373  LUMO = 0.163559691589802
Extra cycle  E= -149.576708688869  delta_E= -1.33e-11  |g|= 1.67e-06  |ddm|= 4.34e-06
converged SCF energy = -149.576708688869  <S^2> = 1.0137942  2S+1 = 2.2483721

******** <class 'pyscf.cc.uccsd.UCCSD'> ********
CC2 = 0
CCSD nocc = (np.int64(8), np.int64(8)), nmo = (28, 28)
frozen orbitals 0
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-06
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 119 MB)
Init t2, MP2 energy = -0.323921294260494
Init E_corr(UCCSD) = -0.323921294262569
cycle = 1  E_corr(UCCSD) = -0.324507227865011  dE = -0.000585933602  norm(t1,t2) = 0.052356
cycle = 2  E_corr(UCCSD) = -0.332068721898277  dE = -0.00756149403  norm(t1,t2) = 0.0189816
cycle = 3  E_corr(UCCSD) = -0.333537418632238  dE = -0.00146869673  norm(t1,t2) = 0.0123699
cycle = 4  E_corr(UCCSD) = -0.334879973174029  dE = -0.00134255454  norm(t1,t2) = 0.0092255
cycle = 5  E_corr(UCCSD) = -0.335206944238198  dE = -0.000326971064  norm(t1,t2) = 0.00698899
cycle = 6  E_corr(UCCSD) = -0.335531460599063  dE = -0.000324516361  norm(t1,t2) = 0.00191929
cycle = 7  E_corr(UCCSD) = -0.335545734517619  dE = -1.42739186e-05  norm(t1,t2) = 0.000278738
cycle = 8  E_corr(UCCSD) = -0.335534674103772  dE = 1.10604138e-05  norm(t1,t2) = 8.50723e-05
cycle = 9  E_corr(UCCSD) = -0.335535531520543  dE = -8.57416771e-07  norm(t1,t2) = 2.64413e-05
cycle = 10  E_corr(UCCSD) = -0.335535407650954  dE = 1.23869589e-07  norm(t1,t2) = 8.24228e-06
cycle = 11  E_corr(UCCSD) = -0.335535467874339  dE = -6.02233854e-08  norm(t1,t2) = 1.50842e-06
cycle = 12  E_corr(UCCSD) = -0.335535399938196  dE = 6.79361434e-08  norm(t1,t2) = 3.83921e-07
UCCSD converged
E(UCCSD) = -149.9122440888075  E_corr = -0.3355353999381956
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-33-generic
# Version: #33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2
# Machine: x86_64
# Processor: x86_64
#
# Preparing AFQMC calculation
# If you import pyscf cc modules and use MPI for AFQMC in the same script, finalize MPI before calling the AFQMC driver.
# Calculating Cholesky integrals
# Finished calculating Cholesky integrals
#
# Size of the correlation space:
# Number of electrons: (8, 8)
# Number of basis functions: 28
# Number of Cholesky vectors: 174
#
# running AFQMC on GPU
# AFQMC script: /home/sharmagroup/sharmagroup/cs_afqmc/ad_afqmc/prop_unrestricted/run_afqmc_ccsd_pt2.py
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-33-generic
# Version: #33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2
# Machine: x86_64
# Processor: x86_64
# Hostname: sharmagroup-rn
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Using GPU.
# System: Linux
# Node Name: sharmagroup-rn
# Release: 6.14.0-33-generic
# Version: #33~24.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Sep 19 17:02:30 UTC 2
# Machine: x86_64
# Processor: x86_64
# Number of MPI ranks: 1
#
# norb: 28
# nelec: (8, 8)
#
# n_eql: 3
# n_prop_steps: 50
# n_ene_blocks: 5
# n_sr_blocks: 10
# n_blocks: 10
# n_walkers: 100
# seed: 2
# walker_type: uhf
# trial: uccsd_pt2_true_ad
# dt: 0.005
# free_projection: False
# use_gpu: True
# n_exp_terms: 6
# orbital_rotation: True
# do_sr: True
# symmetry: False
# save_walkers: False
# ene0: 0.0
# n_batch: 1
# LNO: False
# orbE: 0
# maxError: 0.001
#
# 

# Propagating with 100 walkers
# Equilibration sweeps:
#   Iter  <exp(t1)>  <t2>  <e0>  <e1>  energy  Walltime
      0  0.999053  0.000000  -181.404809   -0.335144   -149.912244  4.40
      1  1.000861  0.102848  -182.069962   -18.718323   -149.922266  28.28
      2  1.000938  0.126498  -182.095276   -23.014471   -149.925999  51.68
      3  1.000840  0.113457  -182.082428   -20.638479   -149.926968  71.77
#
# Sampling sweeps:
#  Iter 	 energy 	 error 	 	 Walltime
     1 	 	 -149.921242 	 0.000077 	  112.02
     2 	 	 -149.921671 	 0.000426 	  132.13
     3 	 	 -149.922422 	 0.000812 	  152.24
     4 	 	 -149.922617 	 0.000653 	  172.35
     5 	 	 -149.922796 	 0.000557 	  192.47
     6 	 	 -149.922758 	 0.000484 	  212.59
     7 	 	 -149.922485 	 0.000501 	  232.77
     8 	 	 -149.922117 	 0.000587 	  252.98
     9 	 	 -149.922054 	 0.000532 	  273.18
# Number of outliers in post: 0 
Final Results1:
# h0 = 32.00000000
# <exp(t1)> = 1.000939 +/- 0.000058
# <t2> = 0.095938 +/- 0.001030
# <e0> = -182.087921 +/- 0.011077
# <e1> = -17.457613 +/- 0.187062
# AFQMC/UCCSD_PT2 energy (covariance): -149.922041 +/- 0.000532
# remove outliers:  0
# AFQMC/UCCSD_PT2 energy (direct obs): -149.921982 +/- 0.000516
# total run time: 273.18
# mem: 1200 MB
